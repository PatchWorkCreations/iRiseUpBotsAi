{% extends "myapp/aibots/base.html" %}
{% load static %}
{% block title %}iRiseUp AI - Your AI Experts{% endblock %}

{% block content %}
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="icon" type="image/png" href="{% static 'myapp/images/iriseup.png' %}">
</head>

<style>
/* üîπ GENERAL STYLES - MATCHING CHATGPT */
body {
    font-family: 'Inter', sans-serif;
    background: #fff;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}





.header {
    position: fixed;
    top: 0;
    width: 100%;
    background: #fff;
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
}

.auth-buttons {
    display: flex;
    gap: 10px;
}

.login-btn {
    background: black;
    color: white;
    padding: 8px 16px;
    font-size: 0.9rem;
    border-radius: 20px;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.3s ease;
}

.login-btn:hover {
    background: #333;
}


@media (max-width: 480px) {
    .auth-buttons {
        flex-direction: column;
        gap: 8px;
    }
}


/* üîπ MAIN CONTAINER */
.chat-container {
    max-width: 800px;
    width: 100%;
    text-align: center;
    margin-top: 100px; /* To avoid overlap with the header */
}



/* Move AI Selector to Top Right */
.move-to-top-right {
    position: absolute;
    top: 10px;
    right: 120px; /* Adjust spacing from login button */
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    background: white;
    padding: 5px 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    z-index: 1000;
}


/* üîπ CHATBOX */
.chat-box {
    background: #ffffff;
    max-width: 750px;
    margin: auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    text-align: left;
    min-height: 300px;
    overflow-y: auto;
    max-height: 400px;
}

/* üîπ CHAT MESSAGES */
.message {
    padding: 12px 15px;
    margin: 12px 0;
    border-radius: 8px;
    max-width: 85%;
    font-size: 1.1rem;
    line-height: 1.4;
    word-wrap: break-word;
}

.message.user {
    background: #2446b6;
    color: white;
    text-align: left;
    margin-left: auto;
    border-radius: 15px 15px 0 15px;
}



.message.bot {
    background: #f1f1f1;
    color: #222;
    text-align: left;
    border-radius: 15px 15px 15px 0;
}



/* üöÄ Trial Limit Message */
#trial-limit-message {
    margin-top: 20px;
    font-size: 1rem;
    color: #d9534f;
    display: none;
    font-weight: bold;
}



/* ‚úÖ AI Switcher for Desktop */
/* üîπ HEADER FIX FOR DESKTOP */
@media (min-width: 769px) {
    .header {
        display: flex;
        justify-content: space-between; /* Ensures AI dropdown & login button align properly */
        align-items: center;
        padding: 15px 20px;
        width: 100%;
    }

    /* Ensure the logo (h1) is visible */
    .header h1 {
        display: block !important; /* Force visibility */
        font-size: 1.3rem;
        font-weight: 600;
    }

    /* ‚úÖ AI switcher should be positioned next to the login button */
    .ai-switcher.moved {
        position: absolute;
        top: 15px;
        right: 200px; /* Ensure it's near the login button */
        font-size: 1rem;
        display: flex;
        align-items: center;
        z-index: 9999;
    }

    /* Ensure dropdown looks correct */
    .ai-switcher.moved select {
        font-size: 1rem;
        padding: 6px 10px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
}


/* ‚úÖ COMPACT AI SWITCHER FOR MOBILE (Prevents Overlapping) */
@media (max-width: 768px) {
    .ai-switcher.moved {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        align-items: center;
        font-size: 1rem;
        font-weight: bold;
        background: white;
        padding: 3px 8px; /* üîπ Reduced padding */
        border-radius: 6px; /* üîπ Smaller radius */
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15); /* üîπ Soft shadow */
        z-index: 1001;
        max-width: 160px; /* üîπ Limits width to prevent overlap */
        overflow: hidden;
        white-space: nowrap;
    }

    /* ‚úÖ Hide "Choose Your AI Assistant" Label */
    .ai-switcher.moved label {
        display: none;
    }

    /* üîπ Compact AI Dropdown */
    .ai-switcher.moved select {
        background: none;
        border: none;
        font-size: 0.9rem; /* üîπ Reduced font size */
        font-weight: bold;
        color: #333;
        cursor: pointer;
        padding: 2px 6px; /* üîπ Reduced padding */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        text-overflow: ellipsis;
        max-width: 140px; /* üîπ Prevents overlap with login */
        overflow: hidden;
        white-space: nowrap;
    }

    /* ‚úÖ Dropdown Arrow */
    .ai-switcher.moved::after {
        content: " ‚åÑ";
        font-size: 12px;
        padding-left: 12px;
        color: #333;
    }

    /* ‚úÖ Keep Login Button on the Right */
    .login-btn {
        position: absolute;
        right: 10px;
        top: 8px;
        z-index: 1003;
        padding: 6px 12px; /* üîπ Smaller button */
        font-size: 0.85rem;
    }
}

.signup{
    background-color: #164922; /* Bootstrap-style green */
    color: white;
}

.signup-btn {
    background-color: #13441d; /* Darker green on hover */
}


/* üé® General Modal Styling */
.signup-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-in-out;
}

/* üíé Modal Content Box */
.signup-modal-content {
    background: #ffffff;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    position: relative;
    animation: slideIn 0.4s ease-in-out;
}

/* ‚ùå Close Button */
.signup-close-button {
    position: absolute;
    top: 12px;
    right: 15px;
    font-size: 22px;
    color: #555;
    cursor: pointer;
    transition: 0.3s ease;
}

.signup-close-button:hover {
    color: #ff4757;
    transform: scale(1.2);
}

/* üöÄ Title Styling */
.signup-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #222;
    margin-bottom: 10px;
    line-height: 1.3;
}

/* üìå Text */
.signup-text {
    font-size: 1.1rem;
    color: #555;
    margin-bottom: 20px;
    line-height: 1.5;
}

/* ‚úÖ Primary CTA Button */
.signup-btn {
    display: inline-block;
    background: linear-gradient(90deg, #025450, #024642);
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
    padding: 12px 25px;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    width: 100%;
    text-align: center;
}

.signup-btn:hover {
    background: linear-gradient(90deg, #024642, #003f80);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0, 123, 255, 0.4);
}

/* üëÄ Secondary Option */
.signup-secondary {
    font-size: 0.9rem;
    color: #666;
    margin-top: 12px;
}

.signup-secondary a {
    color: #025450;
    text-decoration: none;
    font-weight: bold;
}

.signup-secondary a:hover {
    text-decoration: underline;
}

/* üåü Animation Effects */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* üì± Mobile Optimization */
@media (max-width: 480px) {
    .signup-modal-content {
        max-width: 90%;
        padding: 20px;
    }
    
    .signup-title {
        font-size: 1.6rem;
    }

    .signup-text {
        font-size: 1rem;
    }

    .signup-btn {
        font-size: 1.1rem;
        padding: 10px 20px;
    }
}

/* Floating Menu Container */
.floating-menu-container {
    position: fixed;
    bottom: 20px;
    right: 10px; /* Ensure proper alignment */
    z-index: 1000;
}

/* Floating Circular Button */
.floating-button {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #c4c4c5, #9b9b9c);
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
    line-height: 50px;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
    transition: all 0.3s ease-in-out;
}

/* Hover effect */
.floating-button:hover {
    background: linear-gradient(135deg, #a0a0a0, #565657);
    transform: scale(1.1);
}

/* Floating Menu */
.floating-menu {
    position: absolute;
    bottom: 60px;
    right: 0;
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    overflow: hidden;
    display: none;
    flex-direction: column;
    min-width: 180px;
    transform: translateX(-50%); /* Ensure proper alignment */
}

/* Floating Menu Links */
.floating-menu a {
    padding: 12px 16px;
    text-decoration: none;
    color: #333;
    font-size: 1rem;
    display: block;
    transition: background 0.3s;
}

/* Hover effect on menu items */
.floating-menu a:hover {
    background: #f4f4f4;
}


/* üîπ CHAT INPUT BAR */
.chat-footer {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    padding: 12px;
    border-radius: 12px;
    width: 100%;
    max-width: 750px;
    margin: 15px auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

/* üîπ Input Field */
.chat-footer input {
    flex-grow: 1;
    padding: 12px;
    border-radius: 8px;
    border: 2px solid #ddd;
    font-size: 1rem;
    outline: none;
    margin-right: 8px; /* ‚úÖ Adds space between input and mic button */
}

/* üîπ Microphone Button */
.mic-btn {
    background: black;
    color: white;
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    margin-right: 8px; /* ‚úÖ Adds space between mic and send button */
}

/* üîπ Send Button */
.chat-footer button {
    background: black;
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

/* üîπ Hover Effect */
.chat-footer button:hover,
.mic-btn:hover {
    background: #333;
}

/* Typing indicator inside chat bubble */
.typing-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.typing-indicator span {
    width: 6px;
    height: 6px;
    margin: 0 3px;
    border-radius: 50%;
    background-color: #555;
    display: inline-block;
    animation: typing 1.5s infinite;
}

.typing-indicator span:nth-child(1) { animation-delay: 0s; }
.typing-indicator span:nth-child(2) { animation-delay: 0.3s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.6s; }

@keyframes typing {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}


#typing-indicator {
    display: none; /* Hide it by default */
}

.typewriter #dynamic-word::after {
    content: "|";
    animation: blink 0.7s infinite;
    color: #333;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0; }
    100% { opacity: 1; }
}

.message-time {
    font-size: 12px;
    margin-top: 5px;
    opacity: 0.6;
    text-align: right;
}

.suggested-prompts {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 10px auto 5px;
    max-width: 750px;
}

.suggested-prompts button {
    background-color: #f1f1f1;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: background-color 0.3s;
}

.suggested-prompts button:hover {
    background-color: #e0e0e0;
}

/* Ensure mobile Log In button doesn't overlap */
.mobile-login-btn {
  position: absolute;
  right: 60px; /* Space left of hamburger */
  top: 8px;
  z-index: 1003;
  font-size: 0.85rem;
  padding: 6px 12px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  width: 100%;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  z-index: 1000;
  position: fixed;
  top: 0;
}

.tool-btns {
  display: flex;
  gap: 10px;
  flex-direction: row;
  align-items: center;
}

.tool-btns .login-btn {
  white-space: nowrap;
  font-size: 0.85rem;
  padding: 8px 16px;
}

@media (max-width: 480px) {
  .header {
    padding: 10px 15px;
  }

  .tool-btns .login-btn {
    padding: 6px 10px;
    font-size: 0.8rem;
    margin-left: 10px;
  }
}

@media (max-width: 768px) {
  .login-btn.signup {
    display: none !important;
  }
}

.header h1.hidden {
    opacity: 0;
    pointer-events: none;
}

.ai-switcher {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
}

.ai-switcher label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #025450;
    margin-right: 10px;
}

.custom-dropdown {
    position: relative;
    width: fit-content;
}

.dropdown-wrapper {
    border: 2px solid #025450;
    border-radius: 10px;
    cursor: pointer;
    background: #ffffff;
    padding: 12px 16px;
    display: inline-flex;
    align-items: center;
    color: #333;
    transition: all 0.3s ease-in-out;
}

.dropdown-wrapper:hover {
    border-color: #025450;
}

.selected-option {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #025450;
    white-space: nowrap;
}

.selected-option img {
    height: 24px;
    width: 24px;
    object-fit: contain;
}

.dropdown-options {
    list-style: none;
    padding: 0;
    margin: 0;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #ffffff;
    border: 1px solid #ccc;
    border-top: none;
    z-index: 10;
    display: none;
    max-height: 300px;
    overflow-y: auto;
}

.dropdown-options li {
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background 0.2s;
    color: #333;
    white-space: nowrap;
}

.dropdown-options li:hover {
    background: #f1f1f1;
}

.dropdown-options img {
    height: 24px;
    width: 24px;
    object-fit: contain;
}
</style>


<header class="header">
    <h1>
      <img src="{% static 'assets/images/black_logo_long.png' %}" alt="iRiseUp Logo" style="height: 60px;">
    </h1>
  
    <div class="tool-btns">
      <a href="{% url 'signup' %}" class="login-btn signup">Sign up</a>
      <a href="{% url 'sign_in' %}" class="login-btn">Log in</a>
    </div>
  </header>
  


<section class="chat-container">

    
<!-- Floating Menu Button -->
<div class="floating-menu-container">
    <button class="floating-button" onclick="toggleMenu()">‚ùî</button>
    
    <!-- Hidden Menu -->
    <div class="floating-menu" id="floating-menu">
        <a href="{% url 'iriseupai_landing' %}">About iRiseUp.AI</a>
        <!--                   
        <a href="#">Support</a>
        <a href="#">FAQ</a>
        -->
    </div>
</div>

<h2 class="title typewriter" style="font-style: italic;"><span id="dynamic-word"></span></h2>
<!-- ‚úÖ CUSTOM AI STRATEGIST SELECTOR WITH ICONS -->
<div class="ai-switcher custom-dropdown" style="display: flex; justify-content: center; margin-left: 140px;">

    <label for="ai-select">Choose Your Strategist:</label>
    <input type="hidden" id="ai-select" value="lumos">
    <div class="dropdown-wrapper" id="custom-ai-select">
        <div class="selected-option" id="selected-ai">
            <img src="{% static 'icons/lumos.png' %}" alt="Lumos Icon">
            <span>Lumos - Emotional Support</span>
        </div>
        <ul class="dropdown-options">
            <li data-value="lumos">
                <img src="{% static 'icons/lumos.png' %}" alt="Lumos">
                Lumos - Emotional Support
            </li>
            <li data-value="nexara">
                <img src="{% static 'icons/nexara.png' %}" alt="Nexara">
                Nexara - Marketing & Small Biz
            </li>
            <li data-value="thrive">
                <img src="{% static 'icons/thrive.png' %}" alt="Thrive">
                Thrive - Wellness & Fitness
            </li>
            <li data-value="gideon">
                <img src="{% static 'icons/gideon.png' %}" alt="Gideon">
                Gideon - Spiritual & Faith-Based
            </li>
            <li data-value="elevate">
                <img src="{% static 'icons/elevate.png' %}" alt="Elevate">
                Elevate - Business Motivation
            </li>
            <li data-value="keystone">
                <img src="{% static 'icons/keystone.png' %}" alt="Keystone">
                Keystone - Finance & Legal Guidance
            </li>
            <li data-value="mentor-iq">
                <img src="{% static 'icons/mentoriq.png' %}" alt="MentorIQ">
                MentorIQ - Career & Learning Development
            </li>
            <li data-value="imagine">
                <img src="{% static 'icons/imagine.png' %}" alt="Imagine">
                Imagine - Creativity & Ideas
            </li>
            <li data-value="lifewise">
                <img src="{% static 'icons/lifewise.png' %}" alt="LifeWise">
                LifeWise - Everyday Decision Support
            </li>
        </ul>
    </div>
</div>

<!-- ‚úÖ AI Name Display Anchor -->
<div style="display: none">
    <span id="ai-name">Lumos</span>
</div>

  

<div class="chat-box" id="chatbox">
    <div class="message bot" id="ai-greeting">Hi there! üëã I'm <span id="ai-name">Lumos</span>. Ask me anything!</div>
</div>

    <div class="typing-indicator" id="typing-indicator">
        Typing... <span></span><span></span><span></span>
    </div>

    <!-- üí° Suggested Prompts -->
    <div id="suggested-prompts" class="suggested-prompts">
        <!-- Buttons will be added here dynamically -->
    </div>


    <div class="chat-footer">
        <input type="text" id="message" placeholder="Type a message...">
        <button id="send">Send</button>
    </div>

    <p id="trial-limit-message" class="hidden">
        üöÄ You've reached the free trial limit! <a href="{% url 'signup' %}" class="signup-btn">Unlock Full AI Access</a>
    </p>
</section>

<div class="signup-modal" id="signup-modal">
    <div class="signup-modal-content">
        <span class="signup-close-button" onclick="closeSignupModal()">&times;</span>
        
        <!-- üöÄ Stronger Headline -->
        <h2 class="signup-title">üöÄ Don‚Äôt Miss Out on More Chats!</h2>

        <!-- üî• Key Benefit Statement -->
        <p class="signup-text">
            You've hit the free trial limit. Sign up now to unlock more chats and deeper AI insights‚Äîfree!  
        </p>

        <!-- ‚úÖ Action-Oriented CTA -->
        <a href="{% url 'signup' %}" class="signup-btn">üî• Unlock More Chats Now</a>

        <!-- üëÄ Subtle Secondary Option -->
        <p class="signup-secondary">
            No credit card required. <a href="{% url 'iriseupai_landing' %}" onclick="closeSignupModal(); return false;">Maybe later</a>
        </p>
        
    </div>
</div>

<script>
// ‚úÖ Global variables
let chatbox, chatContainer, chatFooter, messageInput, sendButton;
let aiSelect, aiSwitcher, aiNameDisplay, signupModal, titleSection, header, headerTitle;
let micButton = document.createElement("button");
let recognition;
let isRecording = false;
let finalTranscript = "";
let aiMoved = false;
let chatExpanded = false;
let messageCount = parseInt(localStorage.getItem('messageCount')) || 0;
const TRIAL_LIMIT = 10;

// Place this globally at the top (after your global variables are declared)
function addImageMessage(sender, imageUrl) {
    const messageHTML = `
        <div class="message bot">
            <p>Here's your generated image!</p>
            <img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; border-radius: 8px;">
            <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
    `;
    chatbox.innerHTML += messageHTML;
    chatbox.scrollTop = chatbox.scrollHeight;
}


    // ‚úÖ **Send Message to AI**
    function sendMessage() {
    stopRecognition();
    const message = messageInput.value.trim();
    if (!message) return;

    // ‚úÖ Ensure user's message appears instantly
    const userMessageElement = document.createElement('div');
    userMessageElement.classList.add('message', 'user');
    userMessageElement.innerHTML = `
        ${message}
        <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    chatbox.appendChild(userMessageElement);
    chatbox.scrollTop = chatbox.scrollHeight;

    console.log("üì® Sending message:", message);
    console.log("üìä Current message count before increment:", messageCount);
    
    document.getElementById('suggested-prompts').style.display = 'none';
    // Clear input field and focus
    messageInput.value = '';
    messageInput.focus();

    // Hide floating menu if visible
    const floatingMenu = document.querySelector('.floating-menu-container');
    if (floatingMenu) {
        floatingMenu.style.display = "none";
    }

    // Hide title section after first message
    if (titleSection && titleSection.style.display !== "none") {
        titleSection.style.opacity = "0";
        setTimeout(() => {
            titleSection.style.display = 'none';
        }, 300);
    }

    moveAISelector();
    expandChat();

    // üö® Trial limit check
    if (messageCount >= TRIAL_LIMIT) {
        console.log("üö® Trial limit reached! Showing signup modal...");
        document.getElementById("signup-modal").style.display = "flex";
        return;
    }

    // ‚úÖ Add Typing Indicator
    const typingMessage = document.createElement('div');
    typingMessage.classList.add('message', 'bot', 'typing');
    typingMessage.innerHTML = `
        <span class="typing-indicator">
            Typing... <span></span><span></span><span></span>
        </span>
    `;
    chatbox.appendChild(typingMessage);
    chatbox.scrollTop = chatbox.scrollHeight;

    let apiUrl = `/api/guest/chat/${aiSelect.value}/`;
    let requestBody = { message: message };

    // üöÄ Image Generation Logic
    if (aiSelect.value === "imagine") {
    console.log("üé® Image generation triggered for Imagine AI!");
    apiUrl = `/api/guest/chat/imagine/`;  // ‚úÖ Use the existing guest chat endpoint
    requestBody = { message: message };  // ‚úÖ Maintain correct JSON format
}


    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin',
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ AI Response Received:", data);

        // ‚úÖ Remove Typing Indicator Before Adding AI Response
        const typingElement = document.querySelector('.typing');
        if (typingElement) {
            typingElement.remove();
        }

        // ‚úÖ Ensure AI response is added
        if (data.image_url && aiSelect.value === "imagine") {
            addImageMessage('Imagine', data.image_url);
        } else if (data.response) {
            addMessage(aiNameDisplay.textContent, data.response);
        } else {
            console.warn("‚ö†Ô∏è AI Response is empty or undefined.");
            addMessage('System', '‚ö†Ô∏è AI did not return a response. Please try again.');
        }


        // ‚úÖ Update Message Count
        messageCount++;
        localStorage.setItem('messageCount', messageCount);
        console.log("‚úÖ New messageCount after increment:", messageCount);
    })
    .catch(error => {
        console.error('‚ùå Fetch Error:', error);

        // ‚úÖ Remove Typing Indicator on Error
        const typingElement = document.querySelector('.typing');
        if (typingElement) {
            typingElement.remove();
        }

        addMessage('System', '‚ö†Ô∏è Oops! Something went wrong. Please try again.');
    });
}


if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true; // ‚úÖ Allows long speech input
        recognition.interimResults = true; // ‚úÖ Captures partial results
        recognition.lang = "en-US";

        micButton.addEventListener("click", () => {
            if (!isRecording) {
                startRecognition();
            } else {
                stopRecognition();
            }
        });

        function startRecognition() {
            isRecording = true;
            finalTranscript = ""; // ‚úÖ Clear old transcript on start
            micButton.style.backgroundColor = "#ff3b3b"; // Show active recording
            recognition.start();
            console.log("üé§ Voice recognition started...");
        }

        function stopRecognition() {
            if (isRecording) {
                isRecording = false;
                micButton.style.backgroundColor = ""; // Reset color
                recognition.stop();
                console.log("üõë Voice recognition stopped.");
            }
        }

        recognition.onresult = (event) => {
            let newTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    newTranscript += event.results[i][0].transcript + " ";
                }
            }

            finalTranscript += newTranscript.trim(); // ‚úÖ Keep adding to final transcript
            messageInput.value = finalTranscript; // ‚úÖ Show in input field

            console.log("üé§ Full Recognized Speech:", finalTranscript);
        };

        recognition.onend = () => {
            console.log("üé§ Speech recognition ended.");

            if (isRecording && finalTranscript.length > 0) {
                console.log("‚úÖ Final speech transcript:", finalTranscript);
                stopRecognition();
                sendMessage(); // ‚úÖ Send message when user stops speaking
            } else if (isRecording) {
                console.log("üîÑ Restarting speech recognition...");
                recognition.start(); // ‚úÖ Auto-restart if user is still speaking
            }
        };

        recognition.onerror = (event) => {
            console.error("‚ùå Speech recognition error", event);
            if (event.error === "no-speech") {
                console.log("‚è≥ No speech detected, restarting recognition...");
                setTimeout(() => {
                    recognition.start(); // ‚úÖ Auto-restart on no-speech
                }, 1000);
            } else {
                stopRecognition();
            }
        };
    } else {
        console.error("‚ùå Speech recognition is not supported in this browser.");
    }

    function moveAISelector() {
        if (!aiMoved && aiSwitcher) {
            if (window.innerWidth <= 768) {
                headerTitle.style.display = "none"; // Hide the logo on mobile
                aiSwitcher.classList.add('moved'); // Move the AI selector
            } else {
                aiSwitcher.classList.add('moved'); // Desktop: Move beside login button
            }
            aiMoved = true;
            console.log("üéØ AI Selector moved.");
        }
    }

    // ‚úÖ Expand Chat to Full Screen
    function expandChat() {
        if (!chatExpanded) {
            chatContainer.style.height = "100vh";
            chatbox.style.minHeight = "calc(100vh - 150px)"; // Adjust for header/footer
            chatbox.style.overflowY = "auto";
            chatbox.style.padding = "15px"; // Ensure it has some padding

            chatFooter.style.position = "fixed";
            chatFooter.style.bottom = "0";
            chatFooter.style.width = "100%";

            chatExpanded = true;
            console.log("üì± Chat expanded to full-screen.");
        }
    }

    function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : null;
    }

    function addMessage(sender, text) {
    const chatbox = document.getElementById('chatbox');
    if (!chatbox) return;

    const messageClass = sender === 'You' ? 'user' : 'bot';
    const formattedText = text
        .replace(/\n/g, '<br>')
        .replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>')
        .replace(/(^|<br>)([A-Z][A-Za-z\s]+):/g, '$1<strong>$2</strong>:')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    const messageHTML = `
        <div class="message ${messageClass}" style="opacity: 0; transform: translateY(10px); transition: all 0.3s;">
            ${formattedText}
            <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
    `;

    chatbox.innerHTML += messageHTML;
    setTimeout(() => {
        chatbox.lastElementChild.style.opacity = "1";
        chatbox.lastElementChild.style.transform = "translateY(0)";
    }, 100);

    chatbox.scrollTop = chatbox.scrollHeight;
}


document.addEventListener('DOMContentLoaded', function () {
    console.log("‚úÖ Script Loaded!");

    // üåü Retrieve last visit timestamp & reset message count if 24 hours have passed
    const lastVisit = localStorage.getItem('lastVisit');
    const currentTime = new Date().getTime();

    if (!lastVisit || currentTime - lastVisit > 86400000) { // Reset every 24 hours
        localStorage.setItem('messageCount', 0);
        localStorage.setItem('lastVisit', currentTime);
        console.log("üîÑ Message count reset for a new session.");
    }

    // üåü Get DOM elements
    chatbox = document.getElementById('chatbox');
    chatContainer = document.querySelector('.chat-container');
    chatFooter = document.querySelector('.chat-footer');
    messageInput = document.getElementById('message');
    sendButton = document.getElementById('send');
    aiSelect = document.getElementById('ai-select');
    aiSwitcher = document.querySelector('.ai-switcher');
    aiNameDisplay = document.getElementById('ai-name');
    signupModal = document.getElementById('signup-modal');
    titleSection = document.querySelector('.title');
    header = document.querySelector('.header');
    headerTitle = document.querySelector('.header h1');

    // ‚úÖ Mic button
    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
    micButton.classList.add("mic-btn");
    messageInput.insertAdjacentElement("afterend", micButton);
    

    const TRIAL_LIMIT = 10;
    let messageCount = parseInt(localStorage.getItem('messageCount')) || 0;

    console.log("üî• Initial messageCount:", messageCount);

    signupModal.style.display = "none";

    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
    micButton.classList.add("mic-btn");
    messageInput.insertAdjacentElement("afterend", micButton);

    // ‚úÖ Typing Indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'message bot typing-indicator';
    typingIndicator.innerHTML = "Typing...";



    // ‚úÖ Format AI Response
    function formatResponse(text) {
        if (!text) return ""; // Prevent errors if response is undefined

        text = text.replace(/\n/g, '<br>');
        text = text.replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>');
        text = text.replace(/(^|<br>)([A-Z][A-Za-z\s]+):/g, '$1<strong>$2</strong>:');
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        return text;
    }

    
    function showSignupModal() {
    const signupModal = document.getElementById("signup-modal");
    if (signupModal) {
        console.log("üì¢ Showing signup modal...");
        signupModal.style.display = "flex";  // ‚úÖ Ensure the modal is visible
    } else {
        console.error("‚ùå Signup modal element not found!");
    }
}

    function closeSignupModal() {
        const signupModal = document.getElementById("signup-modal");
        if (signupModal) {
            signupModal.style.display = "none";
        } else {
            console.error("‚ùå Signup modal element not found!");
        }
    }

    // ‚úÖ Ensure modal closes when clicking outside
    document.addEventListener("click", function (event) {
        const signupModal = document.getElementById("signup-modal");
        if (signupModal && event.target === signupModal) {
            closeSignupModal();
        }
    });

    function addImageMessage(sender, imageUrl) {
    const messageHTML = `
        <div class="message bot">
            <p>Here‚Äôs your generated image!</p>
            <img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; border-radius: 8px;">
            <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
    `;
    chatbox.innerHTML += messageHTML;
    chatbox.scrollTop = chatbox.scrollHeight;
}


    // ‚úÖ **Handle Enter Key Submission**
    messageInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            stopRecognition();
            sendMessage();
        }
    });

    // ‚úÖ **Handle Button Click Submission**
    sendButton.addEventListener("click", function () {
        stopRecognition(); // ‚úÖ Stop recording before sending
        sendMessage();
    });
});

function toggleMenu() {  // ‚úÖ This function is now globally accessible
    const menu = document.getElementById("floating-menu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

document.addEventListener('DOMContentLoaded', function () {
    console.log("‚úÖ Script Loaded!");
});

document.addEventListener('DOMContentLoaded', function () {
    console.log("‚úÖ Script Loaded!");

    const aiSelect = document.getElementById('ai-select');
    const aiNameDisplay = document.getElementById('ai-name');

    function refreshOnAISwitch() {
        const selectedAI = aiSelect.value;
        console.log(`üîÑ Switching to AI: ${selectedAI}`);

        // Store the selected AI in localStorage so it can be used after refresh
        localStorage.setItem('selectedAI', selectedAI);
        
        // Reload the page to apply changes
        renderSuggestedPrompts();
        location.reload();


    }

    // ‚úÖ Event listener for AI selector changes
    aiSelect.addEventListener('change', refreshOnAISwitch);

    // ‚úÖ Retain selected AI after refresh
    const storedAI = localStorage.getItem('selectedAI');
    if (storedAI) {
        aiSelect.value = storedAI;
        document.getElementById('ai-name').textContent = aiSelect.options[aiSelect.selectedIndex].text.split(" - ")[0].trim();
    }

    // ‚úÖ Function to update AI Name when dropdown is changed
    function updateAIName() {
        const selectedOption = aiSelect.options[aiSelect.selectedIndex].text; // Get selected option's text
        aiNameDisplay.textContent = selectedOption.split(" - ")[0].trim(); // Extract AI name before "-"
        console.log("üîÑ AI Name Updated To:", aiNameDisplay.textContent); // Debugging
    }

    // ‚úÖ Add event listener for AI selector changes
    aiSelect.addEventListener('change', updateAIName);

    // ‚úÖ Initialize AI name on page load
    updateAIName();

});

document.addEventListener("DOMContentLoaded", function () {
    const words = ["LET'S DISCOVER", "LET'S EMPOWER", "LET'S CREATE", "LET'S TRANSFORM", "LET'S LEAD", "LET'S RISE", "LET'S BELONG"];
    const wordElement = document.getElementById("dynamic-word");
    let wordIndex = 0;
    let charIndex = 0;
    let isDeleting = false;

    function typeEffect() {
        const currentWord = words[wordIndex];
        if (!isDeleting) {
            wordElement.textContent = currentWord.substring(0, charIndex + 1);
            charIndex++;
            if (charIndex === currentWord.length) {
                isDeleting = true;
                setTimeout(typeEffect, 1500); // pause before deleting
                return;
            }
        } else {
            wordElement.textContent = currentWord.substring(0, charIndex - 1);
            charIndex--;
            if (charIndex === 0) {
                isDeleting = false;
                wordIndex = (wordIndex + 1) % words.length;
                setTimeout(typeEffect, 300); // pause before typing new word
                return;
            }
        }

        const speed = isDeleting ? 70 : 100;
        setTimeout(typeEffect, speed);
    }

    typeEffect();
});
document.addEventListener('DOMContentLoaded', function () {
    const customSelect = document.getElementById('custom-ai-select');
    const selected = document.getElementById('selected-ai');
    const options = customSelect.querySelector('.dropdown-options');
    const aiNameDisplay = document.getElementById('ai-name');
    const aiGreeting = document.getElementById('ai-greeting');
    const hiddenSelect = document.getElementById('ai-select');
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send');
    const suggestedPromptContainer = document.getElementById("suggested-prompts");

    const suggestions = {
        lumos: ["What‚Äôs a simple morning routine for mental clarity and energy?","Give me a weekly plan to boost brain health at 50+.","How can I optimize my sleep without medication?"],
        nexara: ["Compare the ROI of flipping vs. long-term rental in Ohio.","What‚Äôs a good investment plan with $100k over 2 years?","Help me pitch a real estate investment to private investors."],
        thrive: ["What crops grow best in high-altitude tropical regions?","Help me design an urban garden for a small space.","Give me a 6-month plan for launching a sustainable poultry farm."],
        gideon: ["Share a calming verse or quote from the Quran or Bible about patience.","Guide me through a gratitude meditation from a Buddhist perspective.","Compare Christian, Jewish, and Muslim teachings on forgiveness."],
        elevate: ["Coach me through overcoming my fear of speaking in front of a crowd.","How do I build confidence after repeated rejection?","What daily habits help elevate my presence as a leader?"],
        keystone: ["What should I include in a simple contract for freelance work?","How do I protect my assets before starting a new business?","Give me a 3-year legal and financial plan to build generational wealth."],
        "mentor-iq": ["Help me develop a leadership style that inspires trust.","How can I handle resistance to change within my team?","What are five out-of-the-box solutions for scaling my business fast?"],
        imagine: ["Give me three unique names for a wellness brand rooted in nature.","Help me storyboard a short film about a young inventor.","What would a children‚Äôs book about courage look like?"],
        lifewise: ["Should I leave this job or wait it out? Help me weigh the options.","How do I approach a tough conversation with my partner?","What‚Äôs a graceful way to end a business partnership that no longer aligns?"]
    };

    function renderSuggestedPrompts() {
        const ai = hiddenSelect.value;
        const pool = suggestions[ai] || ["Ask me anything!"];

        suggestedPromptContainer.innerHTML = ''; // Clear old buttons

        pool.slice(0, 3).forEach(prompt => {
            const btn = document.createElement("button");
            btn.textContent = prompt;
            btn.addEventListener("click", function () {
                messageInput.value = prompt;
                sendButton.click();
            });
            suggestedPromptContainer.appendChild(btn);
        });
    }

    selected.addEventListener('click', () => {
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    });

    options.querySelectorAll('li').forEach(option => {
        option.addEventListener('click', () => {
            const value = option.getAttribute('data-value');
            const label = option.textContent.trim();
            const icon = option.querySelector('img').src;

            selected.innerHTML = `<img src="${icon}" alt="icon"><span>${label}</span>`;
            const aiName = label.split(' - ')[0].trim();
            aiNameDisplay.textContent = aiName;
            aiGreeting.innerHTML = `Hi there! üëã I'm <span id="ai-name">${aiName}</span>. Ask me anything!`;
            options.style.display = 'none';

            hiddenSelect.value = value;
            localStorage.setItem('selectedAI', value);

            renderSuggestedPrompts();

            // Force refresh bot behavior after AI change
            location.reload();
        });
    });

    const savedAI = localStorage.getItem('selectedAI');
    if (savedAI) {
        const savedOption = [...options.children].find(li => li.dataset.value === savedAI);
        if (savedOption) {
            const label = savedOption.textContent.trim();
            const icon = savedOption.querySelector('img').src;
            selected.innerHTML = `<img src="${icon}" alt="icon"><span>${label}</span>`;
            const aiName = label.split(' - ')[0].trim();
            aiNameDisplay.textContent = aiName;
            aiGreeting.innerHTML = `Hi there! üëã I'm <span id="ai-name">${aiName}</span>. Ask me anything!`;
            hiddenSelect.value = savedAI;
        }
    }

    renderSuggestedPrompts();
});

function showChatboxChrome() {
    const header = document.getElementById("chatbox-header");
    const footer = document.getElementById("chatbox-footer");
    if (header && footer) {
        header.style.display = "flex";
        footer.style.display = "block";
    }
}
</script>


{% endblock %}