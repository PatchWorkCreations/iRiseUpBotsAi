{% extends "myapp/aibots/bots/bot_base.html" %}
{% block title %}Thrive - Your Health & Wellness Guide{% endblock %}
{% load static %}
{% block content %}


<div class="chat-container">
    <div class="chat-header">
        <button class="back-button" onclick="window.history.back()">
            ‚Üê <!-- Back arrow -->
        </button>
        <div class="header-title">Thrive - Your Health & Wellness Guide ü©∫</div>
    </div>

    <div id="chatbox">
        <!-- Chat messages will appear here -->
    </div>

    <div class="typing-indicator" id="typing-indicator">
        Typing...<span></span><span></span><span></span>
    </div>

    <div class="chat-footer">
        <input type="text" id="message" placeholder="Ask anything about wellness..." autocomplete="off">
        <button id="send">Send</button>
    </div>
</div>

<script>
      const userName = "{{ user_name|default:'there' }}";
    const chatbox = document.getElementById('chatbox');
    const typingIndicator = document.getElementById('typing-indicator');
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send');

    // Function to display messages in the chatbox
    function addMessage(sender, text) {
        const messageClass = sender === 'You' ? 'user' : 'bot';
        const formattedText = formatResponse(text);
        const messageHTML = `
            <div class="message ${messageClass}">
                ${formattedText}
                <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
        `;
        chatbox.innerHTML += messageHTML;
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Show 'Seen' status
    function showSeenStatus() {
        // Check if 'Seen' status already exists
        let seenElement = document.getElementById('seenStatus');
        if (!seenElement) {
            seenElement = document.createElement('div');
            seenElement.id = 'seenStatus';
            seenElement.className = 'seen';
            seenElement.textContent = `Seen ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            chatbox.appendChild(seenElement); // Append 'Seen' status
            chatbox.scrollTop = chatbox.scrollHeight; // Scroll to bottom
        }
    }

    // Remove 'Seen' status
    function removeSeenStatus() {
        const seenElement = document.getElementById('seenStatus');
        if (seenElement) {
            seenElement.remove(); // Remove the element if it exists
        }
    }


    // Format function to handle response formatting
    function formatResponse(text) {
        return text.replace(/\n/g, '<br>');
    }

    // Show and hide typing indicator
    function showTypingIndicator() {
        typingIndicator.style.display = 'flex';
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // Function to send a message
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message === '') return; // Ignore empty messages

        // Display user's message in the chatbox
        addMessage('You', message);

        // Show typing indicator
        showSeenStatus(); // Show 'Seen' status
        showTypingIndicator(); // Show typing indicator

        // Simulate server response
        fetch('/api/chat/pulse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'message': message
            })
        })
            .then(response => response.json())
            .then(data => {
                removeSeenStatus();
                hideTypingIndicator();
                addMessage('Thrive', data.response); // Display bot's response
                messageInput.value = ''; // Clear input field
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Error:', error);
            });
    }

    // Initialize bot greeting
    document.addEventListener('DOMContentLoaded', () => {
        const botGreeting = `Hi, ${userName}! I‚Äôm Thrive! ü©∫ Here to support you on your health journey. How can I assist you today?`;
        addMessage('Thrive', botGreeting);
    });

    // Event listener for Enter key
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default form behavior
            sendMessage(); // Trigger sendMessage
        }
    });

    // Event listener for Send button
    sendButton.addEventListener('click', sendMessage);

</script>

{% endblock %}
