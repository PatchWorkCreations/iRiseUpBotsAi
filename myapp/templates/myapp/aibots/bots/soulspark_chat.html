{% extends "myapp/aibots/bots/bot_base.html" %}
{% block title %}SoulSpark - Mental Health Assistant{% endblock %}
{% load static %}
{% block content %}

<style>
    body {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
    }

    h1 {
        text-align: center;
        padding: 20px 0;
        font-size: 24px;
        color: #333;
    }

    .chat-container {
        max-width: 600px;
        margin: 50px auto;
        border: 1px solid #ddd;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 600px;
    }

    .chat-header {
        background-color: #1F3A93; /* Primary color */
        color: white;
        padding: 10px;
        font-size: 18px;
        display: flex;
        align-items: center;
    }

    .back-button {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        margin-right: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .back-button:hover {
        color: #d1d1d1;
    }

    .header-title {
        flex-grow: 1;
        text-align: center;
        font-weight: bold;
    }

    #chatbox {
        padding: 20px;
        flex-grow: 1;
        overflow-y: auto;
        background-color: #fafafa;
    }

    .message {
        margin-bottom: 10px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 75%;
        word-wrap: break-word;
        display: block;
        clear: both;
    }

    .message.user {
        background-color: #2446b6;
        color: white;
        margin-left: auto;
        text-align: left;
        border-radius: 15px 15px 0 15px;
    }

    .message.bot {
        background-color: #e9ecef;
        color: #333;
        text-align: left;
        border-radius: 15px 15px 15px 0;
    }

    .message-time {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.6;
        text-align: right;
    }

    .typing-indicator {
        display: none;
        margin-top: 10px;
        text-align: left;
    }

    .typing-indicator span {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 50%;
        width: 10px;
        height: 10px;
        margin-right: 3px;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0% { opacity: 0.2; }
        50% { opacity: 1; }
        100% { opacity: 0.2; }
    }

    .chat-footer {
        padding: 10px;
        background-color: #f1f1f1;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    #message {
        width: 85%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 16px;
    }

    #send {
        background-color: #2141aa;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        cursor: pointer;
    }

    #send:hover {
        background-color: #0056b3;
    }

    .seen {
        font-size: 12px;
        color: gray;
        text-align: right;
    }
</style>

<div class="chat-container">
    <div class="chat-header">
        <button class="back-button" onclick="window.history.back()">
            ‚Üê <!-- Unicode arrow for simplicity -->
        </button>
        <div class="header-title">SoulSpark - Mental Health and Wellness AI üßò</div>
    </div>
    <div id="chatbox">
        <!-- Chat messages will appear here -->
    </div>
    <div class="typing-indicator" id="typing-indicator">
        <span></span><span></span><span></span>
    </div>
    <div class="chat-footer">
        <input type="text" id="message" placeholder="Share what's on your mind..." autocomplete="off">
        <button id="send">Send</button>
    </div>
</div>

<script>
    const chatbox = document.getElementById('chatbox');
    const typingIndicator = document.getElementById('typing-indicator');

    // Function to display messages in the chatbox
    function addMessage(sender, text, type = 'bot') {
        const messageClass = sender === 'You' ? 'user' : 'bot';
        const formattedText = formatResponse(text);
        const messageHTML = `
            <div class="message ${messageClass}">
                ${formattedText}
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            </div>
        `;
        chatbox.innerHTML += messageHTML;
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Function to show 'Seen' status
    function showSeenStatus() {
        const seenStatus = '<div id="seenStatus" class="seen">Seen ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) + '</div>';
        chatbox.innerHTML += seenStatus;
    }

    // Remove 'Seen' status
    function removeSeenStatus() {
        const seenElement = document.getElementById('seenStatus');
        if (seenElement) {
            seenElement.remove();
        }
    }

    // Format function to handle different types of response formatting
    function formatResponse(text, keywords = []) {
    // Convert newline characters to HTML line breaks for paragraph separation
    text = text.replace(/\n/g, '<br>');

    // Bold section headers like "Warm-up", "Circuit", etc., by detecting capitalized phrases or standalone lines
    text = text.replace(/(^|<br>)([A-Z][A-Za-z\s]+):/g, '$1<strong>$2</strong>:');

    // Make text within double asterisks bold (**text** -> <strong>text</strong>)
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Convert hyphenated or asterisk bullets into unordered list items
    text = text.replace(/<br>-\s/g, '<ul><li>'); // Start unordered list for bullet points
    text = text.replace(/<\/li><br>-\s/g, '</li><li>'); // Continue unordered list
    text = text.replace(/<\/li><br>/g, '</li></ul>'); // Close unordered list

    // Convert numbered items into an ordered list (1. Item, 2. Item)
    text = text.replace(/<br>(\d+)\.\s/g, (match, p1) => {
        return p1 === "1" ? '<ol><li>' : '</li><li>';
    });
    text = text.replace(/<\/li><br>(?!\d+\.)/g, '</li></ol>'); // Close ordered list at end

    // Handle optional keywords to dynamically bold
    keywords.forEach(keyword => {
        const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
        text = text.replace(regex, '<strong>$1</strong>');
    });

    // Ensure any open lists are closed at the end
    if (!text.endsWith('</ul>')) text += '</ul>';
    if (!text.endsWith('</ol>')) text += '</ol>';

    return text;
}

    // Show and hide typing indicator
    function showTypingIndicator() {
        typingIndicator.style.display = 'flex';
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // Function to initiate the chat with the bot's greeting message
    function initiateBotMessage() {
        const botGreeting = "Hello, I‚Äôm SoulSpark. Here to bring calm, clarity, and a little peace to your day. üå± How are you feeling right now?";
        addMessage('SoulSpark', botGreeting);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initiateBotMessage();
    });

    // Send message on 'Send' button click
    document.getElementById('send').addEventListener('click', function() {
        const message = document.getElementById('message').value;
        if (message.trim() === '') return;

        addMessage('You', message, 'user');

        showSeenStatus();
        showTypingIndicator();

        fetch('/api/chat/soulspark/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'message': message
            })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            removeSeenStatus();
            addMessage('SoulSpark', data.response, 'bot');
            document.getElementById('message').value = '';
        })
        .catch(error => {
            hideTypingIndicator();
            console.error('Error:', error);
        });
    });
</script>
{% endblock %}
